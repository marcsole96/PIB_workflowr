---
title: "Whole data visualization"
output: html_document
editor_options: 
  chunk_output_type: console
---

# Setup

```{r Working directory, echo=TRUE, message=FALSE, warning=FALSE}
#setwd("../PIB_workflowr/data")
getwd()
```

```{r Library load, echo=TRUE, message=FALSE, warning=FALSE}
library(tidyverse)
library(ggplot2)
library(ggfortify)
library(Rtsne)
library(reshape2)
library(ggpubr)
library(gghighlight)
library(plotly)
library(corrplot)
theme_set(theme_minimal())
```

# Data Loading
```{r}
x <- read_tsv("filenames.tsv")

x$fullpath <- paste("", x$filename, sep="")
r <- list()

for (i in 1:nrow(x)) {

  tmp <- read_tsv(x$fullpath[i], col_names = F, col_types = "dd")

  names(tmp) <- c("mz", "intensity")

  tmp <- tmp %>% bind_cols(x[i,])

  r[[length(r)+1]] <- tmp

}

df <- bind_rows(r)
df$pen<-as.character(df$pen)
str(df)

write_rds(df, file = "full_data.rds")

rm(r,tmp,x)
```
## Forth Square root transform



# How does the data look like? 

## Looking at the dataframe
```{r}
head(df,7)

# 4th root transformation of the data
df$intensity<-df$intensity^(1/4)

head(df,7)
```

## Plotting
Basic plot of the three sets of data we have:
```{r}
df %>% ggplot(aes(x=mz,y=intensity))+geom_point(aes(color=pen),alpha=.4) + facet_wrap(~group)
```

Let's check only test and train and facet_wrapping:
```{r}
df %>% filter(group==c("training","test")) %>% ggplot(aes(x=mz,y=intensity))+ geom_point(aes(color=group), size=2, alpha=.4) + facet_wrap(~pen)

df %>% filter(group==c("training","test")) %>% ggplot(aes(x=mz,y=intensity))+ geom_point(aes(color=pen, shape = group), size=2, alpha=.4) + facet_wrap(~group+pen)
```

# Whole data PCA analysis
2d PCA
```{r}
pca_df<-spread(df,mz,intensity)
pr.out <- prcomp(pca_df[,6:(ncol(pca_df)-1)], scale. = TRUE)

autoplot(pr.out, data = pca_df, colour = 'group', shape="group", size=2)+scale_shape_manual(values=c(1, 8, 12))+ scale_color_manual(values=c("black", "darkorange", "dodgerblue"))+geom_text(aes(label=pen),hjust=-1, vjust=1)
```
3d PCA
```{r}

dat_3d <- pr.out$x[,1:3] %>% as_tibble() %>% mutate(group = pca_df$group, pen=pca_df$pen)

fig <- plot_ly(dat_3d, x = ~PC1, y = ~PC2, z = ~PC3, 
               color = ~group,colors = c("black", "darkorange", "dodgerblue"), size = I(100))
fig <- fig %>% add_markers()
fig <- fig %>% layout(scene = list(xaxis = list(title = 'PC1'),
                                   yaxis = list(title = 'PC2'),
                                   zaxis = list(title = 'PC3')))
fig
```

# Contract data PCA analysis

2d PCA
```{r}
pca_df<-df%>%filter(group=="contract") %>% spread(mz,intensity)
pca_df$filename<-gsub(".*_", "", pca_df$filename)
pca_df$filename<-gsub("\\.txt$","",pca_df$filename)
pca_df$filename<-gsub(" ", "_", pca_df$filename)
pca_res <- prcomp(pca_df[,6:(ncol(pca_df)-1)], scale. = TRUE)

autoplot(pca_res, data = pca_df, colour = 'filename', size=2)
```
3d PCA
```{r}
dat_3d <- pca_res$x[,1:3] %>% as_tibble() %>% mutate(filenames = pca_df$filename)

fig <- plot_ly(dat_3d, x = ~PC1, y = ~PC2, z = ~PC3, 
               color =~filenames,colors=c('#8dc5f0','#43abf9','#0092ff','#cef37b','#a6d045','#7caa16','#f8bc7d','#e0892e','#ff8200'), size = I(150))
fig <- fig %>% add_markers()
fig <- fig %>% layout(scene = list(xaxis = list(title = 'PC1'),
                                   yaxis = list(title = 'PC2'),
                                   zaxis = list(title = 'PC3')))

fig
```

# Correlation matrix
```{r}
source("http://www.sthda.com/upload/rquery_cormat.r")

contract<-df%>%filter(group=="contract")

contract$filename<-gsub(".*_", "", contract$filename)
contract$filename<-gsub("\\.txt$","",contract$filename)
contract$filename<-gsub(" ", "_", contract$filename)

contract%>%filter(group=="contract") %>% select("filename","mz","intensity") %>% spread(filename,intensity) %>% rquery.cormat()
```

CLEANING...
```{r}
rm(dat_3d,fig,pca_df,pca_res,pr.out)
```

# PHEATMAP
https://towardsdatascience.com/pheatmap-draws-pretty-heatmaps-483dab9a3cc

```{r}
if("pheatmap" %in% rownames(installed.packages()) == FALSE) {install.packages("pheatmap")}
library(pheatmap)
```

```{r}
contract_hm<-contract%>%filter(group=="contract") %>% select("filename","mz","intensity") %>% spread(filename,intensity)


#The scale function in R performs standard scaling to the columns of the input data, which first subtracts the column means from the columns (center step) and then divides the centered columns by the column standard deviations (scale step)
contract_hm<-scale(contract_hm[,-1])

pheatmap(contract_hm,scale = "row",main = "Pheatmap contract, row scaling")
```

# Coefficient of variation

Calculating the coefficient of variation on every column (mz)
```{r}
contract_CV<-contract%>%filter(group=="contract") %>% select("filename","mz","intensity") %>% spread(mz,intensity)

head(contract_CV,5)
CVs<-sapply(contract_CV, function(x) sd(x) / mean(x) * 100)
CVs[1]<-"Coefficients of Variation"
contract_CV <- rbind(contract_CV, CVs)

(select(contract_CV, 1:5))
```

